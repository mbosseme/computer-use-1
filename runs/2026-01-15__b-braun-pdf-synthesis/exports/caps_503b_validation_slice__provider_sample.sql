-- Provider ERP Sample Extract (Transaction Analysis Expanded)
-- CAPS/503B validation slice — facility-month-NDC aggregate
-- Timeframe: 24 months (Jan 2024 – Dec 2025)
-- Generated: 2025-01-27

DECLARE start_ts TIMESTAMP DEFAULT TIMESTAMP('2024-01-01');
DECLARE end_ts   TIMESTAMP DEFAULT TIMESTAMP('2026-01-01');

WITH ndc_cohort AS (
  SELECT ndc11
  FROM UNNEST([
    '63323017876','63323053075','63323062600','63323062610','63323062625','63323062650','63323062655','63323066710','63323066910','63323068310','63323068610','63323068810','63323082474','63323082475','63323082476','63323086710','63323086774','63323086910','63323086974','63323086975','63323087010','63323087074','63323087310','63323087374','63323087375','65219000401','65219000601','65219000851','65219001001','65219001201','65219011810','65219011910','65219014210','65219014410','65219014610','65219014810','65219015075','65219015310','65219021850','65219022010','65219022225','65219022450','65219023410','65219023610','65219023825','65219024050','65219024110','65219024350','65219024610','65219025810','65219038905','65219038910','65219045660','65219045830','65219046020','65219046210','65219046450','65219046660','65219046850','65219047030','65219047220','65219047410','65219047530','65219047720','65219047910','65219049510','65219049720','65219049930','65219050210','65219050420','65219050630'
  ]) AS ndc11
)

SELECT
  NULLIF(TRIM(CAST(Premier_Entity_Code AS STRING)), '') AS facility_id,
  FORMAT_TIMESTAMP('%Y-%m-01', Transaction_Date) AS month_year,
  REGEXP_REPLACE(CAST(Ndc AS STRING), r'[^0-9]', '') AS ndc11,
  ANY_VALUE(Health_System_Name) AS health_system_name,
  ANY_VALUE(Manufacturer_Name) AS manufacturer_name,
  ANY_VALUE(Contract_Category) AS contract_category,
  SUM(Landed_Spend) AS provider_landed_spend,
  SUM(Base_Spend) AS provider_base_spend,
  SUM(Quantity) AS provider_qty
FROM `abi-inbound-prod.abi_inbound_bq_stg_purchasing_provider_transaction.transaction_analysis_expanded`
WHERE Transaction_Date >= start_ts
  AND Transaction_Date < end_ts
  AND NOT REGEXP_CONTAINS(UPPER(Health_System_Name), r'(\bTEST\b|\bDEMO\b|PREMIER)')
  AND REGEXP_REPLACE(CAST(Ndc AS STRING), r'[^0-9]', '') IN (SELECT ndc11 FROM ndc_cohort)
  AND Premier_Entity_Code IS NOT NULL
GROUP BY 1, 2, 3
ORDER BY provider_landed_spend DESC
LIMIT 500;
